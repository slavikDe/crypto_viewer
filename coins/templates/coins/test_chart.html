<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candlestick Chart</title>
{#    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>#}
{#    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>#}
    <style>
        canvas {
            display: block;
            margin: 50px auto;
        }
        body {
            padding-top: 5vh ;
            background-color: #182432;

        }
    </style>
</head>
<body>
   <canvas id="candlestickChart" width="800" height="400"></canvas>
<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script>
    {#const getHistoricalPrice = async () => {#}
    {#    const url = `/coin/api/historical_price/`; // Ваш Django endpoint#}
    {##}
    {#    try {#}
    {#        const response = await fetch(url);#}
    {#        if (!response.ok) {#}
    {#            throw new Error(`HTTP error! status: ${response.status}`);#}
    {#        }#}
    {##}
    {#        const rawData = await response.json();#}
    {#        console.log("Raw OHLC Data:", rawData);#}
    {##}
    {#        // Форматування всіх даних для Chart.js#}
    {#        const candlestickData = rawData.map(item => {#}
    {#            // Перетворюємо timestamp на дату#}
    {#            const date = new Date(item[0]);#}
    {##}
    {#            // Отримуємо необхідний формат (mm:dd hh:mm)#}
    {#            const formattedDate = `${(date.getMonth() + 1).toString().padStart(2, '0')}:${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;#}
    {##}
    {#            return {#}
    {#                x: date, // Використовуємо об'єкт Date для осі X#}
    {#                o: parseFloat(item[1]), // Open price#}
    {#                h: parseFloat(item[2]), // High price#}
    {#                l: parseFloat(item[3]), // Low price#}
    {#                c: parseFloat(item[4])  // Close price#}
    {#            };#}
    {#        });#}
    {##}
    {#        console.log("Formatted OHLC Data:", candlestickData);#}
    {##}
    {#        // Побудова графіка#}
    {#        buildChart(candlestickData);#}
    {#    } catch (error) {#}
    {#        console.error("Error fetching OHLC data:", error);#}
    {#    }#}
    {#};#}
    {##}
    {#// Функція для побудови графіка#}
    {#const buildChart = (data) => {#}
    {#    const ctx = document.getElementById('candlestickChart').getContext('2d');#}
    {##}
    {#    new Chart(ctx, {#}
    {#        type: 'candlestick',#}
    {#        data: {#}
    {#            datasets: [{#}
    {#                label: 'Candlestick Chart',#}
    {#                data: data,#}
    {#                color: {#}
    {#                    up: 'rgba(0, 200, 0, 0.8)',#}
    {#                    down: 'rgba(200, 0, 0, 0.8)',#}
    {#                    unchanged: 'rgba(128, 128, 128, 0.8)'#}
    {#                },#}
    {#                barPercentage: 0.5,  // Зменшуємо ширину стіків#}
    {#                categoryPercentage: 0.5#}
    {#            }]#}
    {#        },#}
    {#        options: {#}
    {#            responsive: true,#}
    {#            plugins: {#}
    {#                legend: { display: true },#}
    {#                tooltip: {#}
    {#                    callbacks: {#}
    {#                        label: function(context) {#}
    {#                            const ohlc = context.raw;#}
    {#                            return `O: ${ohlc.o}, H: ${ohlc.h}, L: ${ohlc.l}, C: ${ohlc.c}`;#}
    {#                        }#}
    {#                    }#}
    {#                }#}
    {#            },#}
    {#            scales: {#}
    {#                x: {#}
    {#                    type: 'time', // Ось X - часова шкала#}
    {#                    time: {#}
    {#                        unit: 'minute',#}
    {#                        tooltipFormat: 'll HH:mm',#}
    {#                        displayFormats: {#}
    {#                            minute: 'mm:dd HH:mm'#}
    {#                        }#}
    {#                    },#}
    {#                    title: {#}
    {#                        display: true,#}
    {#                        text: 'Date'#}
    {#                    },#}
    {#                    ticks: {#}
    {#                        color: 'black'#}
    {#                    },#}
    {#                    // Додано прокручування та масштабування#}
    {#                    grid: {#}
    {#                        display: false // Вимкнути сітку на осі X для кращої прокрутки#}
    {#                    }#}
    {#                },#}
    {#                y: {#}
    {#                    title: {#}
    {#                        display: true,#}
    {#                        text: 'Price'#}
    {#                    },#}
    {#                    ticks: {#}
    {#                        color: 'black'#}
    {#                    }#}
    {#                }#}
    {#            },#}
    {#            // Параметри для зумування та прокручування#}
    {#            zoom: {#}
    {#                enabled: true,#}
    {#                mode: 'xy',#}
    {#                speed: 0.1,#}
    {#                sensitivity: 3,#}
    {#                limits: {#}
    {#                    x: { min: 0, max: 100 },  // Обмеження для осі X#}
    {#                    y: { min: 0, max: 100 }   // Обмеження для осі Y#}
    {#                }#}
    {#            },#}
    {#            pan: {#}
    {#                enabled: true,#}
    {#                mode: 'xy',#}
    {#                speed: 10,#}
    {#                threshold: 10#}
    {#            }#}
    {#        }#}
    {#    });#}
    {#};#}
    {##}
    {#// Отримання даних і побудова графіка#}
    {#getHistoricalPrice();#}
</script>

    <script>
    // Получение контекста для рисования
    let canvas = window.document.querySelector('canvas');
    let context = canvas.getContext('2d');
    // Переменные
    let chartPrice = null;
    let chartVolume = null;
    // Функции
    const createLineChart = (xData, yData) => {
      let data = {
        labels: xData,
        datasets: [
          {
            type: 'line',
            label: 'Coin price',
            data: yData,
            pointStyle: false,
            fill: true,
            backgroundColor: 'rgba(74, 169, 230, 0.0)',
            borderWidth: 2.5,
            borderColor: 'rgba(74, 169, 230, 1)',
            tension: 0.2

          }
        ]
      }
      let xScaleConfig = {
        min: 0,
        ticks: {
          autoSkip: true,
          // maxRotation: 0,
          minRotation: 45,
          color: 'rgba(74, 169, 230, 0.9)'
        },
        border: {
          color: 'rgba(74, 169, 230, 1)'
        },
        grid: {
          color: 'rgba(74, 169, 230, 0.3)'
        }
      }
      let yScaleConfig = {
        ticks: {
          color: 'rgba(74, 169, 230, 0.9)'
        },
        border: {
          color: 'rgba(74, 169, 230, 1)'
        },
        grid: {
          color: 'rgba(74, 169, 230, 0.3)'
        }
      }
      let zoomOptions = {
        limits: {
          x: {
            min: 0,
            max: 600,
          }
        },
        pan: {
          enabled: true,
          mode: 'x',
        },
        zoom: {
          mode: 'x',
          pinch: {
            enabled: true
          },
          wheel: {
            enabled: true
          },
        }
      }
      let config = {
        data: data,
        options: {
          scales: {
            x: xScaleConfig,
            y: yScaleConfig
          },
          plugins: {
            legend: {
              display: false
            },
            zoom: zoomOptions
          },
        }
      }
      chartPrice = new Chart(context, config);

    }

    const getHistoricalPrice = async () => {
      const url = '/coin/api/historical_price/';

      try {
      const response = await fetch(url);
      const data = await response.json();


      let xDataLine = [];
      let yDataLine = [];
      let xDataBar = [];
      let yDataBar = [];
      let formattedDate;

      for (let i =0; i < data.length; i++){
        formattedDate = new Date(data[i][0]).toLocaleString('uk-UA', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,  // Формат 24 години
        });

        xDataLine.push(formattedDate);
        yDataLine.push(data[i][1]);

      }
      createLineChart(xDataLine, yDataLine); // Вашу функцію графіку

      } catch (error) {
        console.error('Error fetching data:', error); // Обробка помилок
        }

    }
    getHistoricalPrice();

    </script>
</body>
</html>
